<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Remnant Protocol: Tactical Link II</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (compat for browser HTML usage) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      background: black;
      font-family: 'Orbitron', sans-serif;
      height: 100vh;
      overflow: hidden;
    }
    #root {
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    /**********************************************************
     * FIREBASE INITIALIZATION (UPDATED PROJECT)
     **********************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyADBJENDCNCtWxoC-OP2A2jDeoPs_Oc3Co",
      authDomain: "poly-game-97ca7.firebaseapp.com",
      projectId: "poly-game-97ca7",
      storageBucket: "poly-game-97ca7.firebasestorage.app",
      messagingSenderId: "126069067766",
      appId: "1:126069067766:web:8c94639ae4fb06db5c41d7",
      measurementId: "G-Y89VKPKVVY"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const analytics = firebase.analytics();
    const auth = firebase.auth();
    const db = firebase.firestore();

    // App ID used by original game logic
    const __app_id = "remnantprotocoltacticallink2";

    /**********************************************************
     * GAME CODE CONTINUES IN PART 2
     **********************************************************/
  </script>
</body>
</html>
/**********************************************************
 * REACT IMPORTS
 **********************************************************/
const { useState, useEffect, useRef } = React;

/**********************************************************
 * CAMPAIGN CONSTANTS
 **********************************************************/
const CAMPAIGN_STAGES = [
  { 
    sector: "SECTOR 0: WHITE",
    levels: [
      { id: "0-1", name: "Alpha Sweep", target: 5, speedMult: 1, description: "Clear initial hostiles." },
      { id: "0-2", name: "Bravo Link", target: 8, speedMult: 1.1, description: "Secure the communications relay." },
      { id: "0-3", name: "Charlie Gate", target: 12, speedMult: 1.2, description: "Defend the extraction point." }
    ]
  },
  { 
    sector: "SECTOR 1: VOID",
    levels: [
      { id: "1-1", name: "Dark Perimeter", target: 15, speedMult: 1.3, description: "Patrol the outer shadow zones." },
      { id: "1-2", name: "Null Chamber", target: 18, speedMult: 1.4, description: "Neutralize high-density clusters." },
      { id: "1-3", name: "Void Core", target: 22, speedMult: 1.5, description: "Shutdown the anomalous power source." }
    ]
  },
  { 
    sector: "SECTOR 2: NULL",
    levels: [
      { id: "2-1", name: "Edge of Reality", target: 25, speedMult: 1.6, description: "Engage targets in low-visibility." },
      { id: "2-2", name: "The Abyss", target: 30, speedMult: 1.7, description: "Survive the onslaught." },
      { id: "2-3", name: "Protocol Omega", target: 40, speedMult: 1.9, description: "Final purge of the Sector." }
    ]
  }
];

/**********************************************************
 * MAIN APP COMPONENT (PARTIAL)
 **********************************************************/
function App() {
  const [user, setUser] = useState(null);
  const [gameState, setGameState] = useState('MENU'); 
  const [currentLevelId, setCurrentLevelId] = useState("0-1"); 
  const [savedProgress, setSavedProgress] = useState(0); 
  const [kills, setKills] = useState(0);
  const [hp, setHp] = useState(100);
  const [ammo, setAmmo] = useState(30);
  const [gameMode, setGameMode] = useState('CAMPAIGN'); 
  const [sessionId, setSessionId] = useState('');
  const [joinId, setJoinId] = useState('');
  const [copyFeedback, setCopyFeedback] = useState(null);

  // Arcade State
  const [punchScore, setPunchScore] = useState(0);
  const [indicatorPos, setIndicatorPos] = useState(0);
  const [isPunching, setIsPunching] = useState(false);
  const [bowlingScore, setBowlingScore] = useState(0);
  const [pins, setPins] = useState([1,1,1,1,1,1,1,1,1,1]);
  const [isRolling, setIsRolling] = useState(false);
  const [ballX, setBallX] = useState(50);
  const [ballY, setBallY] = useState(0);

  const containerRef = useRef(null);
  const canvasRef = useRef(null);
  const engine = useRef({
    scene: null,
    camera: null,
    renderer: null,
    clock: null,
    remnants: [],
    collidables: [],
    move: { forward: false, backward: false, left: false, right: false },
    playing: false,
    loopStarted: false
  });

  /**********************************************************
   * FONT ENSURE
   **********************************************************/
  useEffect(() => {
    const link = document.createElement('link');
    link.href = 'https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap';
    link.rel = 'stylesheet';
    document.head.appendChild(link);
  }, []);

  /**********************************************************
   * AUTH INITIALIZATION
   **********************************************************/
  useEffect(() => {
    auth.signInAnonymously();
    const unsubscribe = auth.onAuthStateChanged(setUser);
    return () => unsubscribe();
  }, []);

  /**********************************************************
   * CAMPAIGN PROGRESS SYNC
   **********************************************************/
  useEffect(() => {
    if (!user) return;

    const progressDoc = db
      .collection('artifacts')
      .doc(__app_id)
      .collection('users')
      .doc(user.uid)
      .collection('progress')
      .doc('campaign');

    const unsub = progressDoc.onSnapshot((snapshot) => {
      if (snapshot.exists) {
        setSavedProgress(snapshot.data().levelCount || 0);
      }
    }, console.error);

    return () => unsub();
  }, [user]);

  /**********************************************************
   * KEYBOARD FOCUS
   **********************************************************/
  useEffect(() => {
    if (gameState === 'PLAYING' && containerRef.current) {
      containerRef.current.focus();
    }
  }, [gameState]);
  /**********************************************************
   * DOWNLOAD LOGIC (UNCHANGED)
   **********************************************************/
  const handleDownload = () => {
    const gameCodeRaw = document.querySelector('script[type="text/babel"]')?.textContent || "";
    const htmlContent = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Remnant Protocol: Tactical Link 2</title>
</head>
<body>
<pre>${gameCodeRaw.replace(/</g,"&lt;")}</pre>
</body>
</html>`;

    const el = document.createElement('textarea');
    el.value = htmlContent;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    setCopyFeedback("COPIED! PASTE INTO AN HTML FILE.");
    setTimeout(() => setCopyFeedback(null), 3000);
  };

  /**********************************************************
   * ARCADE: POWER PUNCH
   **********************************************************/
  useEffect(() => {
    let anim;
    if (gameState === 'PUNCH_GAME' && !isPunching) {
      const update = () => {
        setIndicatorPos(p => (p + 2) % 100);
        anim = requestAnimationFrame(update);
      };
      anim = requestAnimationFrame(update);
    }
    return () => cancelAnimationFrame(anim);
  }, [gameState, isPunching]);

  const handlePunch = () => {
    if (isPunching) return;
    setIsPunching(true);
    const dist = Math.abs(50 - indicatorPos);
    const score = Math.max(0, Math.floor(1000 - dist * 20));
    setPunchScore(score);
    setTimeout(() => setIsPunching(false), 2000);
  };

  /**********************************************************
   * ARCADE: BOWLING
   **********************************************************/
  useEffect(() => {
    let anim;
    if (gameState === 'BOWLING_GAME') {
      if (!isRolling) {
        const update = () => {
          setBallX(x => 50 + Math.sin(Date.now() / 200) * 30);
          anim = requestAnimationFrame(update);
        };
        anim = requestAnimationFrame(update);
      } else {
        const update = () => {
          setBallY(y => {
            const next = y + 2;
            if (next > 100) {
              const hitChance = 1 - Math.abs(50 - ballX) / 50;
              const newPins = pins.map(p => (p && Math.random() < hitChance ? 0 : p));
              const fallen = pins.filter((p, i) => p && !newPins[i]).length;
              setBowlingScore(s => s + fallen);
              setPins(newPins);
              setIsRolling(false);
              setBallY(0);
              if (newPins.every(p => !p)) {
                setTimeout(() => setPins([1,1,1,1,1,1,1,1,1,1]), 1000);
              }
              return 0;
            }
            return next;
          });
          anim = requestAnimationFrame(update);
        };
        anim = requestAnimationFrame(update);
      }
    }
    return () => cancelAnimationFrame(anim);
  }, [gameState, isRolling, pins, ballX]);
  /**********************************************************
   * THREE.JS ENGINE INIT
   **********************************************************/
  const initEngine = () => {
    if (engine.current.renderer) {
      engine.current.scene.clear();
    } else {
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      canvasRef.current.appendChild(renderer.domElement);
      engine.current.renderer = renderer;
    }

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f0f0);
    scene.fog = new THREE.FogExp2(0xf0f0f0, 0.03);
    engine.current.scene = scene;

    const camera = new THREE.PerspectiveCamera(
      75,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.rotation.order = 'YXZ';
    camera.position.set(
      (Math.random() - 0.5) * 10,
      1.7,
      (Math.random() - 0.5) * 10
    );
    engine.current.camera = camera;

    scene.add(new THREE.DirectionalLight(0xffffff, 1));
    scene.add(new THREE.AmbientLight(0xffffff, 0.8));

    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(1000, 1000),
      new THREE.MeshStandardMaterial({ color: 0xffffff })
    );
    ground.rotation.x = -Math.PI / 2;
    scene.add(ground);

    engine.current.collidables = [];
    for (let i = 0; i < 40; i++) {
      const h = 2 + Math.random() * 20;
      const p = new THREE.Mesh(
        new THREE.BoxGeometry(4, h, 4),
        new THREE.MeshStandardMaterial({ color: 0xdddddd })
      );
      const x = (Math.random() - 0.5) * 150;
      const z = (Math.random() - 0.5) * 150;
      p.position.set(x, h / 2, z);
      scene.add(p);
      engine.current.collidables.push({
        pos: new THREE.Vector3(x, 0, z),
        radius: 3
      });
    }

    const gun = new THREE.Group();
    const body = new THREE.Mesh(
      new THREE.BoxGeometry(0.15, 0.2, 0.6),
      new THREE.MeshStandardMaterial({ color: 0x111111 })
    );
    const barrel = new THREE.Mesh(
      new THREE.CylinderGeometry(0.04, 0.04, 0.4),
      new THREE.MeshStandardMaterial({ color: 0x000000 })
    );
    barrel.rotation.x = Math.PI / 2;
    barrel.position.z = -0.4;
    gun.add(body, barrel);
    gun.position.set(0.35, -0.3, -0.6);
    camera.add(gun);
    scene.add(camera);

    engine.current.clock = new THREE.Clock();
    if (!engine.current.loopStarted) {
      engine.current.loopStarted = true;
      animate();
    }
  };

  /**********************************************************
   * ENEMY SPAWNING
   **********************************************************/
  const spawnRemnant = (speedMult) => {
    const group = new THREE.Group();
    const mat = new THREE.MeshStandardMaterial({
      color: 0x1a1a1a,
      roughness: 0.2,
      metalness: 0.8
    });

    const torso = new THREE.Mesh(
      new THREE.OctahedronGeometry(0.6, 0),
      mat
    );
    torso.position.y = 1.3;
    torso.scale.y = 1.5;
    group.add(torso);

    const head = new THREE.Mesh(
      new THREE.ConeGeometry(0.2, 0.5, 4),
      mat
    );
    head.position.y = 2.1;
    head.rotation.x = Math.PI;
    group.add(head);

    const angle = Math.random() * Math.PI * 2;
    const dist = 35 + Math.random() * 15;
    group.position.set(
      Math.cos(angle) * dist,
      0,
      Math.sin(angle) * dist
    );

    group.userData = {
      hp: 50,
      speed: (0.04 + Math.random() * 0.04) * speedMult
    };

    engine.current.scene.add(group);
    engine.current.remnants.push(group);
  };

  /**********************************************************
   * MAIN ANIMATION LOOP
   **********************************************************/
  const animate = () => {
    requestAnimationFrame(animate);

    const {
      renderer,
      scene,
      camera,
      clock,
      move,
      remnants,
      collidables,
      playing
    } = engine.current;

    if (!renderer || !playing || !camera) return;

    const delta = clock.getDelta();
    const direction = new THREE.Vector3();

    if (move.forward) direction.z -= 1;
    if (move.backward) direction.z += 1;
    if (move.left) direction.x -= 1;
    if (move.right) direction.x += 1;

    if (direction.length() > 0) {
      direction.normalize().multiplyScalar(10 * delta);
      const oldPos = camera.position.clone();
      camera.translateZ(direction.z);
      camera.translateX(direction.x);

      for (let c of collidables) {
        const dist = new THREE.Vector2(
          camera.position.x - c.pos.x,
          camera.position.z - c.pos.z
        ).length();
        if (dist < 1.2 + c.radius) {
          camera.position.copy(oldPos);
          break;
        }
      }
    }

    camera.position.y = 1.7;

    remnants.forEach((r) => {
      r.lookAt(camera.position.x, 0, camera.position.z);
      r.translateZ(r.userData.speed);
      if (r.position.distanceTo(camera.position) < 2.5) {
        setHp(prev => {
          const next = prev - (10 * delta);
          if (next <= 0 && !engine.current.dead) {
            engine.current.dead = true;
            setGameState('DEATH');
            document.exitPointerLock();
          }
          return next;
        });
      }
    });

    renderer.render(scene, camera);
  };
  /**********************************************************
   * START MISSION
   **********************************************************/
  const startMission = (lvlId, mode = 'CAMPAIGN', sId = null) => {
    if (sId) setSessionId(sId);
    setCurrentLevelId(lvlId);
    setGameMode(mode);
    setKills(0);
    setHp(100);
    setAmmo(30);
    setGameState('PLAYING');

    engine.current.playing = true;
    engine.current.dead = false;

    initEngine();
    engine.current.remnants = [];

    const lvlData = CAMPAIGN_STAGES
      .flatMap(s => s.levels)
      .find(l => l.id === lvlId);

    const target = mode === 'CAMPAIGN' ? lvlData.target : 20;
    const speed = mode === 'CAMPAIGN' ? lvlData.speedMult : 1.3;

    for (let i = 0; i < target; i++) {
      spawnRemnant(speed);
    }

    setTimeout(() => {
      if (canvasRef.current) {
        canvasRef.current.requestPointerLock();
      }
    }, 100);
  };

  /**********************************************************
   * SHOOTING
   **********************************************************/
  const handleShoot = () => {
    if (gameState !== 'PLAYING' || ammo <= 0) return;

    setAmmo(prev => prev - 1);

    const ray = new THREE.Raycaster();
    ray.setFromCamera(
      new THREE.Vector2(0, 0),
      engine.current.camera
    );

    const hits = ray.intersectObjects(
      engine.current.remnants,
      true
    );

    if (hits.length > 0) {
      let target = hits[0].object;
      while (
        target.parent &&
        !engine.current.remnants.includes(target)
      ) {
        target = target.parent;
      }

      target.userData.hp -= 25;

      if (target.userData.hp <= 0) {
        engine.current.scene.remove(target);
        engine.current.remnants =
          engine.current.remnants.filter(r => r !== target);

        setKills(prev => {
          const next = prev + 1;

          const currentLvl = CAMPAIGN_STAGES
            .flatMap(s => s.levels)
            .find(l => l.id === currentLevelId);

          const goal =
            gameMode === 'CAMPAIGN'
              ? currentLvl.target
              : 20;

          if (next >= goal) {
            engine.current.playing = false;
            document.exitPointerLock();
            setGameState('WIN_LEVEL');

            if (gameMode === 'CAMPAIGN' && user) {
              const allLvlIds = CAMPAIGN_STAGES.flatMap(
                s => s.levels.map(l => l.id)
              );
              const currentIdx =
                allLvlIds.indexOf(currentLevelId);

              if (currentIdx + 1 > savedProgress) {
                db.collection('artifacts')
                  .doc(__app_id)
                  .collection('users')
                  .doc(user.uid)
                  .collection('progress')
                  .doc('campaign')
                  .set({
                    levelCount: currentIdx + 1,
                    lastUpdated: Date.now()
                  });
              }
            }
          }
          return next;
        });
      }
    }

    if (ammo === 1) {
      setTimeout(() => setAmmo(30), 1200);
    }
  };

  /**********************************************************
   * RESUME GAME
   **********************************************************/
  const resumeGame = () => {
    setGameState('PLAYING');
    engine.current.playing = true;
    if (canvasRef.current) {
      canvasRef.current.requestPointerLock();
    }
  };
  /**********************************************************
   * INPUT HANDLERS
   **********************************************************/
  const handleKeyDown = (e) => {
    switch (e.key) {
      case 'w': case 'ArrowUp': engine.current.move.forward = true; break;
      case 's': case 'ArrowDown': engine.current.move.backward = true; break;
      case 'a': case 'ArrowLeft': engine.current.move.left = true; break;
      case 'd': case 'ArrowRight': engine.current.move.right = true; break;
      case ' ': handleShoot(); break;
      case 'Escape': 
        if (gameState === 'PLAYING') setGameState('PAUSED');
        break;
      default: break;
    }
  };

  const handleKeyUp = (e) => {
    switch (e.key) {
      case 'w': case 'ArrowUp': engine.current.move.forward = false; break;
      case 's': case 'ArrowDown': engine.current.move.backward = false; break;
      case 'a': case 'ArrowLeft': engine.current.move.left = false; break;
      case 'd': case 'ArrowRight': engine.current.move.right = false; break;
      default: break;
    }
  };

  /**********************************************************
   * MAIN JSX
   **********************************************************/
  return (
    <div
      ref={containerRef}
      tabIndex={0}
      className="w-full h-full outline-none relative"
      onKeyDown={handleKeyDown}
      onKeyUp={handleKeyUp}
    >
      <div ref={canvasRef} className="w-full h-full"></div>

      {gameState === 'MENU' && (
        <div className="absolute inset-0 flex flex-col justify-center items-center text-white bg-black bg-opacity-80">
          <h1 className="text-5xl mb-8">REMNANT PROTOCOL</h1>
          <button
            className="px-6 py-3 bg-gray-700 hover:bg-gray-500 mb-2"
            onClick={() => startMission("0-1", 'CAMPAIGN')}
          >
            START CAMPAIGN
          </button>
          <button
            className="px-6 py-3 bg-gray-700 hover:bg-gray-500 mb-2"
            onClick={() => setGameState('PUNCH_GAME')}
          >
            POWER PUNCH
          </button>
          <button
            className="px-6 py-3 bg-gray-700 hover:bg-gray-500"
            onClick={() => setGameState('BOWLING_GAME')}
          >
            BOWLING ARCADE
          </button>
        </div>
      )}

      {gameState === 'HUD' || gameState === 'PLAYING' ? (
        <div className="absolute top-2 left-2 text-white">
          <div>HP: {Math.floor(hp)}</div>
          <div>KILLS: {kills}</div>
          <div>AMMO: {ammo}</div>
        </div>
      ) : null}

      {gameState === 'PUNCH_GAME' && (
        <div className="absolute inset-0 flex flex-col justify-center items-center text-white bg-black bg-opacity-90">
          <div className="w-1/2 h-4 bg-gray-600 mb-4 relative">
            <div
              className="absolute top-0 left-0 h-4 bg-red-500"
              style={{ width: `${indicatorPos}%` }}
            ></div>
          </div>
          <button
            className="px-6 py-3 bg-gray-700 hover:bg-gray-500"
            onClick={handlePunch}
            disabled={isPunching}
          >
            PUNCH
          </button>
          <div className="mt-4">SCORE: {punchScore}</div>
        </div>
      )}

      {gameState === 'BOWLING_GAME' && (
        <div className="absolute inset-0 flex flex-col justify-center items-center text-white bg-black bg-opacity-90">
          <div className="w-64 h-2 bg-gray-600 mb-4 relative">
            {pins.map((p, i) => (
              <div
                key={i}
                className={`absolute top-0 w-5 h-2 ${p ? 'bg-red-500' : 'bg-gray-800'}`}
                style={{ left: `${i*6}%` }}
              ></div>
            ))}
          </div>
          <button
            className="px-6 py-3 bg-gray-700 hover:bg-gray-500"
            onClick={() => setIsRolling(true)}
            disabled={isRolling}
          >
            ROLL BALL
          </button>
          <div className="mt-4">SCORE: {bowlingScore}</div>
        </div>
      )}

      {gameState === 'PAUSED' && (
        <div className="absolute inset-0 flex flex-col justify-center items-center text-white bg-black bg-opacity-80">
          <h2 className="text-3xl mb-4">PAUSED</h2>
          <button
            className="px-6 py-3 bg-gray-700 hover:bg-gray-500"
            onClick={resumeGame}
          >
            RESUME
          </button>
        </div>
      )}

      {gameState === 'WIN_LEVEL' && (
        <div className="absolute inset-0 flex flex-col justify-center items-center text-white bg-black bg-opacity-90">
          <h2 className="text-4xl mb-4">LEVEL COMPLETE!</h2>
          <button
            className="px-6 py-3 bg-gray-700 hover:bg-gray-500"
            onClick={() => setGameState('MENU')}
          >
            RETURN TO MENU
          </button>
        </div>
      )}

      {gameState === 'DEATH' && (
        <div className="absolute inset-0 flex flex-col justify-center items-center text-white bg-black bg-opacity-90">
          <h2 className="text-4xl mb-4">YOU DIED</h2>
          <button
            className="px-6 py-3 bg-gray-700 hover:bg-gray-500"
            onClick={() => startMission(currentLevelId, gameMode, sessionId)}
          >
            RETRY
          </button>
        </div>
      )}

      {copyFeedback && (
        <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white bg-green-700 px-4 py-2 rounded">
          {copyFeedback}
        </div>
      )}
    </div>
  );
}

/**********************************************************
 * RENDER APP
 **********************************************************/
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
